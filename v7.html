<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¸­æ›¿ãˆæ¢åµğŸ•µ Plus</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@500;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Zen Maru Gothic', sans-serif; background-color: #f0f9ff; }
        .seat-input { transition: all 0.2s; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .seat-input:focus { transform: scale(1.05); z-index: 10; border-color: #0ea5e9; ring: 2px solid #0ea5e9; }
        .modal { background-color: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .hl-kw { background-color: #e0f2fe; color: #0369a1; font-weight: bold; padding: 0 4px; border-radius: 4px; }
        /* Animation */
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.9); } 100% { opacity: 1; transform: scale(1); } }
        .animate-pop { animation: popIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-700 select-none">

    <div id="loginScreen" class="flex-1 flex flex-col items-center justify-center p-4 bg-slate-100 z-50">
        <div class="bg-white p-8 rounded-2xl shadow-xl max-w-md w-full border-4 border-white ring-4 ring-slate-100">
            <h1 class="text-4xl font-black text-center mb-2 text-sky-600 tracking-widest">å¸­æ›¿ãˆæ¢åµğŸ•µ<span class="text-sm text-pink-500">Plus</span></h1>
            <p class="text-center text-gray-400 mb-8 text-xs font-bold">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ¨ç†ã‚²ãƒ¼ãƒ <br>Made by 32Pdesu (Modified)</p>
            
            <div class="mb-5">
                <label class="block text-sm font-bold mb-2 text-slate-500">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </label>
                <input type="text" id="nicknameInput" maxlength="10" class="w-full border-2 border-slate-200 p-3 rounded-xl focus:outline-none focus:border-sky-500 font-bold text-lg text-center" placeholder="åå‰ã‚’å…¥åŠ›">
            </div>

            <div id="initialButtons" class="flex gap-3 mb-4">
                <button onclick="showCreateOptions()" class="flex-1 bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition transform active:scale-95">éƒ¨å±‹ã‚’ä½œã‚‹</button>
                <button onclick="showJoinOptions()" class="flex-1 bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition transform active:scale-95">éƒ¨å±‹ã«å…¥ã‚‹</button>
            </div>

            <div id="hostOptions" class="hidden space-y-4 border-t-2 border-dashed border-slate-200 pt-4 animate-pop">
                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-1">éƒ¨å±‹ã‚³ãƒ¼ãƒ‰</label>
                    <div class="flex gap-2">
                        <input type="text" id="createRoomCode" class="flex-1 bg-slate-100 border-none p-2 rounded-lg font-mono text-center font-bold tracking-widest" readonly>
                        <button onclick="generateRoomCode()" class="bg-slate-200 hover:bg-slate-300 px-3 rounded-lg text-xs font-bold">æ›´æ–°</button>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1">é›£æ˜“åº¦</label>
                        <select id="difficultySelect" class="w-full bg-slate-50 border-2 border-slate-200 p-2 rounded-lg font-bold text-sm">
                            <option value="0">åˆç´š (6å¸­)</option>
                            <option value="1">ä¸­ç´š (12å¸­)</option>
                            <option value="2">ä¸Šç´š (20å¸­)</option>
                            <option value="3">é¬¼ (30å¸­)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1">å•é¡Œç•ªå·</label>
                        <div class="flex gap-1">
                            <select id="questionId" class="flex-1 bg-slate-50 border-2 border-slate-200 p-2 rounded-lg font-bold text-sm"></select>
                            <button onclick="randomQuestion()" class="bg-purple-100 text-purple-600 px-2 rounded-lg text-xs font-bold">ä¹±</button>
                        </div>
                    </div>
                </div>
                <button onclick="initializeLobby()" class="w-full bg-sky-600 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-sky-700 transition">ãƒ­ãƒ“ãƒ¼ã‚’ä½œæˆ</button>
                <button onclick="resetLogin()" class="w-full text-slate-400 text-xs font-bold hover:underline">æˆ»ã‚‹</button>
            </div>

            <div id="joinOptions" class="hidden space-y-4 border-t-2 border-dashed border-slate-200 pt-4 animate-pop">
                <div>
                    <label class="block text-sm font-bold mb-1 text-slate-500">éƒ¨å±‹ã‚³ãƒ¼ãƒ‰å…¥åŠ›</label>
                    <input type="text" id="joinRoomCode" class="w-full border-2 border-slate-200 p-3 rounded-xl uppercase font-mono text-center tracking-widest text-xl focus:border-emerald-500 focus:outline-none" placeholder="ABC12345">
                </div>
                <button onclick="joinRoom()" class="w-full bg-emerald-600 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-emerald-700 transition">å‚åŠ ã™ã‚‹</button>
                <button onclick="resetLogin()" class="w-full text-slate-400 text-xs font-bold hover:underline">æˆ»ã‚‹</button>
            </div>
        </div>
    </div>

    <div id="lobbyScreen" class="hidden h-full flex flex-col md:flex-row bg-slate-50 relative">
        <button onclick="exitRoom()" class="absolute top-4 right-4 z-50 bg-white p-2 rounded-full shadow hover:bg-rose-50 text-rose-500 transition border border-rose-100" title="é€€å‡ºã™ã‚‹">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9" />
            </svg>
        </button>

        <div class="flex-1 p-6 flex flex-col items-center justify-center">
            <div class="bg-white p-8 rounded-3xl shadow-lg w-full max-w-2xl border border-slate-100">
                <h2 class="text-3xl font-black text-slate-700 mb-2 text-center">å¾…æ©Ÿä¸­...</h2>
                <div class="flex justify-center mb-6">
                    <button onclick="copyToClipboard()" class="group relative bg-slate-100 hover:bg-slate-200 px-6 py-2 rounded-full font-mono text-2xl font-bold tracking-widest text-sky-600 transition border-2 border-slate-200">
                        <span id="lobbyCodeDisplay">------</span>
                        <span class="absolute -top-8 left-1/2 -translate-x-1/2 bg-black text-white text-xs py-1 px-2 rounded opacity-0 group-hover:opacity-100 transition">ã‚¯ãƒªãƒƒã‚¯ã§ã‚³ãƒ”ãƒ¼</span>
                    </button>
                </div>

                <div class="mb-6">
                    <p class="text-xs font-bold text-slate-400 uppercase mb-2 text-center">å‚åŠ è€…ãƒªã‚¹ãƒˆ</p>
                    <div id="memberList" class="flex flex-wrap justify-center gap-3"></div>
                </div>

                <div id="hostControls" class="hidden w-full space-y-3">
                    <div class="bg-amber-50 p-3 rounded-lg text-amber-800 text-xs font-bold text-center border border-amber-100">
                        â€» å…¨å“¡æƒã£ãŸã‚‰é–‹å§‹ã—ã¦ãã ã•ã„
                    </div>
                    <button onclick="startGame()" class="w-full bg-gradient-to-r from-sky-500 to-indigo-600 text-white py-4 rounded-xl font-black text-xl shadow-xl hover:shadow-2xl transition transform hover:-translate-y-1">ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
                </div>
                <div id="clientControls" class="hidden w-full">
                    <p class="text-center text-slate-500 font-bold animate-pulse">ãƒ›ã‚¹ãƒˆãŒé–‹å§‹ã™ã‚‹ã®ã‚’å¾…ã£ã¦ã„ã¾ã™...</p>
                </div>
            </div>
        </div>
        
        <div class="h-1/3 md:h-auto md:w-80 bg-white border-l border-slate-200 flex flex-col">
            <div class="p-3 border-b bg-slate-50 font-bold text-slate-600">ğŸ’¬ ãƒ­ãƒ“ãƒ¼ãƒãƒ£ãƒƒãƒˆ</div>
            <div id="lobbyChat" class="flex-1 overflow-y-auto p-3 space-y-2 bg-slate-50"></div>
            <form onsubmit="sendChat(event, 'lobby')" class="p-3 bg-white border-t">
                <div class="flex gap-2">
                    <input type="text" id="lobbyChatInput" class="flex-1 border rounded-lg px-3 py-2 text-sm" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸...">
                    <button class="bg-sky-500 text-white px-4 rounded-lg font-bold text-sm">é€ä¿¡</button>
                </div>
            </form>
        </div>
    </div>

    <div id="gameScreen" class="hidden h-full flex flex-col bg-slate-200">
        <header class="bg-white px-4 py-2 flex justify-between items-center shadow-sm z-20">
            <div class="flex items-center gap-4">
                <div class="bg-slate-800 text-white px-4 py-1 rounded-lg font-mono text-xl font-bold tracking-widest" id="timer">00:00</div>
                <div class="text-xs font-bold text-slate-500 hidden md:block">Room: <span id="gameRoomCode"></span></div>
            </div>
            <div class="flex gap-2 items-center">
                <button onclick="toggleTab('seats')" id="btnSeats" class="md:hidden px-3 py-1 bg-sky-100 text-sky-700 rounded font-bold text-xs">åº§å¸­</button>
                <button onclick="toggleTab('hints')" id="btnHints" class="md:hidden px-3 py-1 bg-slate-100 text-slate-500 rounded font-bold text-xs">ãƒ’ãƒ³ãƒˆ</button>
                <button onclick="toggleTab('chat')" id="btnChat" class="md:hidden px-3 py-1 bg-slate-100 text-slate-500 rounded font-bold text-xs">ãƒãƒ£ãƒƒãƒˆ</button>
                
                <div id="hostGameControls" class="hidden flex gap-2 ml-4 border-l pl-4">
                    <button onclick="checkAnswers()" class="bg-rose-500 hover:bg-rose-600 text-white px-4 py-1 rounded-lg text-sm font-bold shadow">ç­”ãˆåˆã‚ã›</button>
                </div>

                <button onclick="exitRoom()" class="ml-4 bg-slate-100 p-2 rounded-full hover:bg-rose-50 text-rose-500 transition border border-slate-200" title="é€€å‡ºã™ã‚‹">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9" />
                    </svg>
                </button>
            </div>
        </header>

        <div class="flex-1 flex overflow-hidden relative">
            
            <div id="panelHints" class="hidden md:flex flex-col w-72 bg-white border-r border-slate-200 z-10 absolute md:relative h-full">
                <div class="p-3 bg-indigo-50 text-indigo-800 font-bold text-sm flex justify-between">
                    <span>ğŸ“¢ é…ã‚‰ã‚ŒãŸãƒ’ãƒ³ãƒˆ</span>
                    <span id="hintCount" class="bg-indigo-200 px-2 rounded text-xs py-0.5">0</span>
                </div>
                <div id="myHints" class="flex-1 overflow-y-auto p-3 space-y-3 bg-slate-50"></div>
            </div>

            <div id="panelSeats" class="flex-1 flex flex-col relative overflow-hidden bg-slate-200 w-full">
                <div class="absolute top-2 left-0 right-0 text-center pointer-events-none opacity-50 font-bold text-slate-400 text-sm">é»’æ¿ (å‰æ–¹)</div>
                <div class="absolute bottom-2 left-0 right-0 text-center pointer-events-none opacity-50 font-bold text-slate-400 text-sm">å¾Œæ–¹</div>
                <div class="absolute left-2 top-1/2 -rotate-90 pointer-events-none opacity-50 font-bold text-slate-400 text-sm">çª“éš›</div>
                <div class="absolute right-2 top-1/2 rotate-90 pointer-events-none opacity-50 font-bold text-slate-400 text-sm">å»Šä¸‹</div>

                <div class="flex-1 overflow-auto p-8 flex items-center justify-center">
                    <div id="seatGrid" class="grid gap-4 w-full max-w-4xl transition-all"></div>
                </div>
            </div>

            <div id="panelChat" class="hidden md:flex flex-col w-72 bg-white border-l border-slate-200 z-10 absolute md:relative h-full right-0">
                <div class="p-3 bg-slate-50 border-b font-bold text-slate-600">ğŸ’¬ ç›¸è«‡ãƒãƒ£ãƒƒãƒˆ</div>
                <div id="gameChat" class="flex-1 overflow-y-auto p-3 space-y-2 bg-white"></div>
                <form onsubmit="sendChat(event, 'game')" class="p-3 bg-slate-50 border-t">
                    <div class="flex gap-2">
                        <input type="text" id="gameChatInput" class="flex-1 border rounded-lg px-2 py-2 text-sm" placeholder="/op answerã§ç­”ãˆ...">
                        <button class="bg-indigo-500 text-white px-3 rounded-lg font-bold text-sm">é€ä¿¡</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="resultModal" class="hidden fixed inset-0 modal flex items-center justify-center z-50 p-4">
        <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <h2 class="text-4xl font-black text-center text-transparent bg-clip-text bg-gradient-to-r from-emerald-500 to-sky-500 mb-2">CLEAR!</h2>
            <p class="text-center text-slate-500 font-bold mb-6">ã‚¿ã‚¤ãƒ : <span id="resultTime" class="text-2xl font-mono text-slate-800">00:00</span></p>
            
            <div class="bg-emerald-50 p-6 rounded-2xl border-4 border-emerald-100 mb-6">
                <h3 class="text-center font-bold text-emerald-800 mb-4">æ­£è§£ã®åº§å¸­è¡¨</h3>
                <div id="resultGrid" class="grid gap-2"></div>
            </div>
            
            <div class="flex justify-center">
                <button onclick="location.reload()" class="bg-slate-800 text-white px-8 py-3 rounded-full font-bold shadow-lg hover:bg-slate-700">ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹</button>
            </div>
        </div>
    </div>

<script>
/* =========================================
   CONFIG & DATA
   ========================================= */
const MQTT_BROKER = "broker.emqx.io";
const MQTT_PORT = 8084;
const NAMES_DB = [
    "ã‚ãŠã„","ã‚ã‹ã‚Š","ã‚ã•ã²","ã„ã¤ã","ã†ãŸ","ãˆã„ã¨","ãˆã¾","ã‹ã„ã¨","ã‹ãª","ãŒã",
    "ã“ã¯ã‚‹","ã•ãã‚‰","ã•ã‚‰","ã—ãŠã‚Š","ãã†ãŸ","ãŸã„ãŒ","ã¡ã²ã‚","ã¤ã‚€ã","ã¨ã†ã¾","ãªãã•",
    "ãªãª","ã¯ã‚‹ã¨","ã²ãªãŸ","ãµã†ã‹","ã»ã®ã‹","ã¾ãŠ","ã¿ãŠ","ã¿ã•ã","ã¿ãªã¨","ã‚ã„",
    "ã‚†ã„","ã‚†ã†ã¨","ã‚†ãšã","ã‚Šã","ã‚Šã‚“","ã‚‹ã„","ã‚Œã‚“","ã‚ã‹ã°"
];
const LEVELS = [
    { r:2, c:3, name:"åˆç´š" }, { r:3, c:4, name:"ä¸­ç´š" }, { r:4, c:5, name:"ä¸Šç´š" }, { r:5, c:6, name:"é¬¼" }
];
const NOISE_TEXTS = [
    "ã¯çœ ãã†ã ", "ã¯çœ¼é¡ã‚’ã‹ã‘ã¦ã„ã‚‹", "ã¯ãƒãƒ¼ãƒˆã‚’ã¨ã£ã¦ã„ã‚‹", "ã¯æ¶ˆã—ã‚´ãƒ ã‚’è½ã¨ã—ãŸ",
    "ã¯å¤–ã‚’è¦‹ã¦ã„ã‚‹", "ã¯ã‚ãã³ã‚’ã—ãŸ", "ã¯èƒŒä¼¸ã³ã‚’ã—ã¦ã„ã‚‹", "ã¯æ°´ã‚’é£²ã‚“ã§ã„ã‚‹",
    "ã¯é«ªã‚’è§¦ã£ã¦ã„ã‚‹", "ã¯ãƒšãƒ³ã‚’å›ã—ã¦ã„ã‚‹"
];

// Global State
let client;
let roomId = "";
let myName = "";
let isHost = false;
let gameState = {
    status: "lobby", // lobby, playing, finished
    members: [],
    startTime: 0,
    seats: [],      // current input
    answer: [],     // 2D array of names
    playerHints: {}, // { "playerName": ["hint1", "hint2"] }
    chat: [],
    settings: {}
};
let timerInterval;

/* =========================================
   1. LOGIC GENERATOR (Enhanced)
   ========================================= */
function mulberry32(a) {
    return function() {
        var t = a += 0x6D2B79F5;
        t = Math.imul(t ^ (t >>> 15), t | 1);
        t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
        return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
    }
}

function generateScenario(levelIdx, questionId) {
    const seed = (levelIdx + 1) * 10000 + questionId;
    const rng = mulberry32(seed);
    
    const rows = LEVELS[levelIdx].r;
    const cols = LEVELS[levelIdx].c;
    const total = rows * cols;
    
    // 1. Shuffle Names
    let pool = [...NAMES_DB].sort(() => rng() - 0.5);
    let usedNames = pool.slice(0, total);
    let grid = [];
    let k = 0;
    for(let r=0; r<rows; r++){
        let row = [];
        for(let c=0; c<cols; c++) row.push(usedNames[k++]);
        grid.push(row);
    }
    
    // 2. Generate Spanning Tree Hints (Guarantees Connectivity)
    let hints = [];
    let visited = new Set(["0,0"]);
    let queue = [{r:0, c:0}];
    
    const addHint = (txt) => { if(!hints.includes(txt)) hints.push(txt); };

    // Anchor 1: Start
    addHint(`${grid[0][0]}ã¯ä¸€ç•ªå‰ã®å·¦ç«¯ï¼ˆçª“éš›ï¼‰ã®å¸­ã `);

    while(visited.size < total) {
        if(queue.length === 0) break;
        const currIdx = Math.floor(rng() * queue.length);
        const curr = queue[currIdx];
        const cName = grid[curr.r][curr.c];

        const neighbors = [];
        const dirs = [ {r:-1,c:0,n:'å‰'}, {r:1,c:0,n:'å¾Œ'}, {r:0,c:-1,n:'å·¦'}, {r:0,c:1,n:'å³'} ];
        
        dirs.forEach(d => {
            const nr = curr.r + d.r;
            const nc = curr.c + d.c;
            if(nr>=0 && nr<rows && nc>=0 && nc<cols && !visited.has(`${nr},${nc}`)) {
                neighbors.push({r:nr, c:nc, dir:d.n});
            }
        });

        if(neighbors.length > 0) {
            const target = neighbors[Math.floor(rng() * neighbors.length)];
            const tName = grid[target.r][target.c];
            visited.add(`${target.r},${target.c}`);
            queue.push(target);
            
            if(target.dir === 'å‰') addHint(`${tName}ã¯${cName}ã®ã™ãå‰ã«ã„ã‚‹`);
            if(target.dir === 'å¾Œ') addHint(`${tName}ã¯${cName}ã®ã™ãå¾Œã‚ã«ã„ã‚‹`);
            if(target.dir === 'å·¦') addHint(`${tName}ã¯${cName}ã®å·¦éš£ã«ã„ã‚‹`);
            if(target.dir === 'å³') addHint(`${tName}ã¯${cName}ã®å³éš£ã«ã„ã‚‹`);
        } else {
            queue.splice(currIdx, 1);
        }
    }

    // 3. Add Extra Logical Hints & Anchor End
    addHint(`${grid[rows-1][cols-1]}ã¯ä¸€ç•ªå¾Œã‚ã®å³ç«¯ï¼ˆå»Šä¸‹å´ï¼‰ã®å¸­ã `);

    // Add redundant but helpful hints (Cross referencing)
    const extraCount = Math.floor(total * 0.8);
    for(let i=0; i<extraCount; i++) {
        const r = Math.floor(rng() * rows);
        const c = Math.floor(rng() * cols);
        const name = grid[r][c];
        const type = Math.floor(rng() * 4); 

        if(type === 0) { // Row info
            if(r === 0) addHint(`${name}ã¯ä¸€ç•ªå‰ã®åˆ—ã `);
            else if(r === rows-1) addHint(`${name}ã¯ä¸€ç•ªå¾Œã‚ã®åˆ—ã `);
            else addHint(`${name}ã¯å‰ã‹ã‚‰${r+1}ç•ªç›®ã®åˆ—ã«ã„ã‚‹`);
        }
        else if(type === 1) { // Col info
            let partnerR = Math.floor(rng()*rows);
            while(partnerR === r) partnerR = Math.floor(rng()*rows);
            addHint(`${name}ã¨${grid[partnerR][c]}ã¯åŒã˜ç¸¦ã®åˆ—ã `);
        }
        else if(type === 2) { // Corner/Edge
            if(c === 0) addHint(`${name}ã¯çª“éš›ã®åˆ—ã«ã„ã‚‹`);
            else if(c === cols-1) addHint(`${name}ã¯å»Šä¸‹å´ã®åˆ—ã«ã„ã‚‹`);
        }
        else if(type === 3 && c < cols-2) { // Skip
            addHint(`${name}ã®2ã¤å³éš£ã¯${grid[r][c+2]}ã `);
        }
    }

    // 4. GUARANTEE ALL NAMES APPEAR
    const hintsStr = hints.join("::");
    usedNames.forEach(name => {
        if(!hintsStr.includes(name)) {
            let pr = -1, pc = -1;
            for(let r=0; r<rows; r++) {
                if(grid[r].includes(name)) { pr=r; pc=grid[r].indexOf(name); break; }
            }
            if(pr !== -1) {
                 addHint(`${name}ã¯å‰ã‹ã‚‰${pr+1}ç•ªç›®ã€å·¦ã‹ã‚‰${pc+1}ç•ªç›®ã®å¸­ã `);
            }
        }
    });

    // 5. ADD NOISE (Ratio increased to 25%)
    // Noise hints are formatted to look REAL but contain useless info
    const hintCount = hints.length;
    // Increased from 0.15 to 0.25 (25%)
    const noiseCount = Math.floor(hintCount * 0.25); 
    for(let i=0; i<noiseCount; i++) {
        const r = Math.floor(rng() * rows);
        const c = Math.floor(rng() * cols);
        const name = grid[r][c];
        const noise = NOISE_TEXTS[Math.floor(rng() * NOISE_TEXTS.length)];
        hints.push(`[æƒ…å ±] ${name}${noise}`);
    }

    return { grid, hints: hints.sort(() => rng() - 0.5) };
}

/* =========================================
   2. UI INTERACTIONS
   ========================================= */
function init() {
    const sel = document.getElementById("questionId");
    for(let i=1; i<=25; i++) {
        sel.innerHTML += `<option value="${i}">ç¬¬ ${i} å•</option>`;
    }
}
window.onload = init;

function showCreateOptions() {
    document.getElementById("initialButtons").classList.add("hidden");
    document.getElementById("hostOptions").classList.remove("hidden");
    generateRoomCode();
}
function showJoinOptions() {
    document.getElementById("initialButtons").classList.add("hidden");
    document.getElementById("joinOptions").classList.remove("hidden");
}
function resetLogin() {
    document.getElementById("hostOptions").classList.add("hidden");
    document.getElementById("joinOptions").classList.add("hidden");
    document.getElementById("initialButtons").classList.remove("hidden");
}
function exitRoom() {
    if(confirm("é€€å‡ºã—ã¦ãƒˆãƒƒãƒ—ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ")) {
        location.reload();
    }
}

function generateRoomCode() {
    const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
    let code = "";
    for(let i=0; i<6; i++) code += chars.charAt(Math.floor(Math.random() * chars.length));
    document.getElementById("createRoomCode").value = code;
}
function randomQuestion() {
    document.getElementById("questionId").value = Math.floor(Math.random()*25)+1;
}

/* =========================================
   3. MAIN GAME FLOW (HOST)
   ========================================= */
function initializeLobby() {
    myName = document.getElementById("nicknameInput").value || "åç„¡ã—";
    roomId = document.getElementById("createRoomCode").value;
    const diff = parseInt(document.getElementById("difficultySelect").value);
    const qId = parseInt(document.getElementById("questionId").value);

    isHost = true;
    
    gameState = {
        status: "lobby",
        members: [myName],
        startTime: 0,
        settings: { diff, qId },
        answer: [],
        seats: Array(LEVELS[diff].r * LEVELS[diff].c).fill(""),
        chat: [],
        playerHints: {} 
    };

    connectMQTT(() => {
        updateLobbyUI();
        document.getElementById("hostControls").classList.remove("hidden");
    });
}

function startGame() {
    if(!isHost) return;
    
    const scenario = generateScenario(gameState.settings.diff, gameState.settings.qId);
    gameState.answer = scenario.grid;
    
    // Distribute Hints evenly
    const deck = [...scenario.hints];
    gameState.playerHints = {};
    gameState.members.forEach(m => gameState.playerHints[m] = []);
    
    let playerIdx = 0;
    while(deck.length > 0) {
        const card = deck.pop();
        const targetPlayer = gameState.members[playerIdx];
        gameState.playerHints[targetPlayer].push(card);
        playerIdx = (playerIdx + 1) % gameState.members.length;
    }

    gameState.status = "playing";
    gameState.startTime = Date.now();
    
    sendSync();
    setupGameUI();
}

function checkAnswers() {
    const flatAns = gameState.answer.flat();
    let correct = 0;
    gameState.seats.forEach((s, i) => {
        if(s && s === flatAns[i]) correct++;
    });
    
    if(correct === flatAns.length) {
        const time = document.getElementById("timer").innerText;
        sendMessage("finish", { time });
    } else {
        alert(`ä¸æ­£è§£ã§ã™ï¼\nç¾åœ¨ ${correct} / ${flatAns.length} æ­£è§£`);
    }
}

/* =========================================
   4. MAIN GAME FLOW (CLIENT)
   ========================================= */
function joinRoom() {
    myName = document.getElementById("nicknameInput").value || "ã‚²ã‚¹ãƒˆ";
    roomId = document.getElementById("joinRoomCode").value.toUpperCase();
    if(!roomId) return alert("éƒ¨å±‹ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

    isHost = false;
    connectMQTT(() => {
        sendMessage("join", { name: myName });
        document.getElementById("clientControls").classList.remove("hidden");
    });
}

/* =========================================
   5. MQTT & SYNC
   ========================================= */
function connectMQTT(callback) {
    const clientId = "seat_" + Math.random().toString(16).substr(2, 8);
    client = new Paho.MQTT.Client(MQTT_BROKER, MQTT_PORT, "/mqtt", clientId);
    
    client.onMessageArrived = onMessage;
    client.onConnectionLost = (e) => console.log("Lost connection", e);

    client.connect({
        useSSL: true,
        onSuccess: () => {
            client.subscribe(`seatgame/${roomId}/#`);
            callback();
        },
        onFailure: (e) => alert("æ¥ç¶šå¤±æ•—: " + e.errorMessage)
    });
}

function sendMessage(type, payload) {
    const msg = new Paho.MQTT.Message(JSON.stringify(payload));
    msg.destinationName = `seatgame/${roomId}/${type}`;
    client.send(msg);
}

function sendSync() {
    const now = Date.now();
    const elapsed = gameState.startTime > 0 ? now - gameState.startTime : 0;
    const payload = {
        ...gameState,
        elapsedTimeForSync: elapsed 
    };
    sendMessage("sync", payload);
}

function onMessage(msg) {
    const topic = msg.destinationName.split("/").pop();
    const data = JSON.parse(msg.payloadString);

    if(topic === "join" && isHost) {
        if(!gameState.members.includes(data.name)) {
            gameState.members.push(data.name);
            sendSync();
        }
    }
    else if(topic === "sync") {
        const prevStatus = gameState.status;
        const elapsed = data.elapsedTimeForSync || 0;
        delete data.elapsedTimeForSync;
        gameState = data;
        
        if(gameState.status === "playing") {
             gameState.startTime = Date.now() - elapsed;
        }

        // çŠ¶æ…‹é·ç§»ã«å¿œã˜ãŸUIæ›´æ–°
        if(gameState.status === "lobby") {
            updateLobbyUI();
        } else if(gameState.status === "playing") {
            // ã‚²ãƒ¼ãƒ ä¸­ãªã‚‰å³åº§ã«ç”»é¢åˆ‡ã‚Šæ›¿ãˆï¼ˆé€”ä¸­å‚åŠ å¯¾å¿œï¼‰
            setupGameUI();
        } else {
            updateGameSeats();
        }
    }
    else if(topic === "seatUpdate") {
        gameState.seats = data;
        updateGameSeats();
    }
    else if(topic === "chat") {
        if(data.isSystemAnswer) {
             appendChat(data.source, "SYSTEM", data.msg, true);
        } else {
             appendChat(data.source, data.user, data.msg);
        }
    }
    else if(topic === "finish") {
        showResult(data.time);
    }
}

/* =========================================
   6. DOM UPDATES
   ========================================= */
function updateLobbyUI() {
    document.getElementById("loginScreen").classList.add("hidden");
    document.getElementById("gameScreen").classList.add("hidden");
    document.getElementById("lobbyScreen").classList.remove("hidden");
    document.getElementById("lobbyCodeDisplay").innerText = roomId;
    
    const list = document.getElementById("memberList");
    list.innerHTML = "";
    gameState.members.forEach(m => {
        list.innerHTML += `<div class="bg-white px-4 py-2 rounded-full border border-slate-200 font-bold text-slate-600 shadow-sm flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-green-500"></div>${m}</div>`;
    });
}

function copyToClipboard() {
    navigator.clipboard.writeText(roomId);
    const btn = document.getElementById("lobbyCodeDisplay");
    const original = btn.innerText;
    btn.innerText = "COPIED!";
    setTimeout(() => btn.innerText = original, 1000);
}

function setupGameUI() {
    // Force Hide other screens (Important for late join)
    document.getElementById("loginScreen").classList.add("hidden");
    document.getElementById("lobbyScreen").classList.add("hidden");
    
    document.getElementById("gameScreen").classList.remove("hidden");
    document.getElementById("gameRoomCode").innerText = roomId;
    if(isHost) document.getElementById("hostGameControls").classList.remove("hidden");

    const lvl = LEVELS[gameState.settings.diff];
    const grid = document.getElementById("seatGrid");
    grid.style.gridTemplateColumns = `repeat(${lvl.c}, minmax(0, 1fr))`;
    grid.innerHTML = "";
    
    for(let i=0; i<lvl.r * lvl.c; i++) {
        const div = document.createElement("div");
        div.className = "aspect-video bg-amber-100 rounded-lg shadow border-b-4 border-amber-200 relative";
        
        const input = document.createElement("input");
        input.className = "seat-input absolute inset-0 w-full h-full bg-transparent text-center font-bold text-lg md:text-xl text-slate-800 placeholder-amber-300/50 focus:bg-white rounded-lg";
        input.placeholder = "åå‰";
        input.oninput = (e) => {
            gameState.seats[i] = e.target.value;
            sendMessage("seatUpdate", gameState.seats);
        };
        div.appendChild(input);
        grid.appendChild(div);
    }

    const myHand = gameState.playerHints[myName] || [];
    const container = document.getElementById("myHints");
    container.innerHTML = "";
    document.getElementById("hintCount").innerText = myHand.length;
    
    const kws = ['å³','å·¦','å‰','å¾Œ','éš£','åˆ—','çª“','å»Šä¸‹'];
    
    // Style class is now identical for Noise and Real hints
    const commonStyle = "border-indigo-400 text-slate-700 font-medium";

    myHand.forEach(h => {
        let html = h;
        const isNoise = h.startsWith("[æƒ…å ±]");
        
        // ãƒã‚¤ãƒ©ã‚¤ãƒˆå‡¦ç†ã®ã¿ã€ãƒã‚¤ã‚ºã§ãªã„å ´åˆã«é©ç”¨
        if(!isNoise) {
            kws.forEach(k => html = html.replace(new RegExp(k,'g'), `<span class="hl-kw">${k}</span>`));
        } else {
            // Remove the prefix for display so it looks completely real/innocent
            html = html.replace("[æƒ…å ±] ", "");
        }

        container.innerHTML += `<div class="bg-white p-3 rounded border-l-4 ${commonStyle} shadow-sm text-sm">${html}</div>`;
    });

    if(timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(() => {
        const diff = Math.floor((Date.now() - gameState.startTime) / 1000);
        if(diff < 0) return;
        const m = String(Math.floor(diff/60)).padStart(2,'0');
        const s = String(diff%60).padStart(2,'0');
        document.getElementById("timer").innerText = `${m}:${s}`;
    }, 1000);
    
    toggleTab('seats');
}

function updateGameSeats() {
    const inputs = document.querySelectorAll(".seat-input");
    inputs.forEach((inp, i) => {
        if(document.activeElement !== inp) {
            inp.value = gameState.seats[i] || "";
            if(inp.value) inp.parentElement.classList.add("bg-white");
            else inp.parentElement.classList.remove("bg-white");
        }
    });
}

/* =========================================
   7. CHAT & UTILS
   ========================================= */
function sendChat(e, area) {
    e.preventDefault();
    const inputId = area === 'lobby' ? 'lobbyChatInput' : 'gameChatInput';
    const input = document.getElementById(inputId);
    const text = input.value.trim();
    if(!text) return;

    if(text === "/op answer") {
        const ansStr = formatAnswerGrid(gameState.answer);
        appendChat(area, "SYSTEM (Private)", `<div class="font-mono text-xs whitespace-pre bg-gray-100 p-2 rounded border border-gray-300 mt-1">${ansStr}</div>`, true);
        input.value = "";
        return;
    }
    if(text === "/op answer all") {
        const ansStr = formatAnswerGrid(gameState.answer);
        const html = `<div class="font-bold text-red-500 mb-1">æ­£è§£å…¬é–‹:</div><div class="font-mono text-xs whitespace-pre bg-red-50 p-2 rounded border border-red-200">${ansStr}</div>`;
        sendMessage("chat", { source: area, user: "SYSTEM", msg: html, isSystemAnswer: true });
        input.value = "";
        return;
    }
    
    sendMessage("chat", { source: area, user: myName, msg: text });
    input.value = "";
}

function formatAnswerGrid(grid) {
    if(!grid || grid.length === 0) return "No Data";
    return grid.map(row => row.map(n => n.padEnd(4, 'ã€€')).join(" | ")).join("\n" + "-".repeat(grid[0].length * 6) + "\n");
}

function appendChat(source, user, msg, isHtml = false) {
    const boxId = source === 'lobby' ? 'lobbyChat' : 'gameChat';
    const box = document.getElementById(boxId);
    if(!box) return;
    
    const div = document.createElement("div");
    div.className = "text-sm mb-2 break-words";
    const content = isHtml ? msg : `<div class="bg-indigo-50 inline-block px-3 py-1 rounded-r-lg rounded-bl-lg text-slate-700 mt-1">${msg}</div>`;
    div.innerHTML = `<span class="font-bold text-slate-500 text-xs">${user}</span>${isHtml ? "" : "<br>"}${content}`;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
}

function toggleTab(tab) {
    const pSeats = document.getElementById("panelSeats");
    const pHints = document.getElementById("panelHints");
    const pChat = document.getElementById("panelChat");
    
    if(window.innerWidth < 768) {
        pSeats.classList.add("hidden");
        pHints.classList.add("hidden");
        pChat.classList.add("hidden");
        
        if(tab === 'seats') pSeats.classList.remove("hidden");
        if(tab === 'hints') { pHints.classList.remove("hidden"); pHints.classList.add("absolute", "w-full", "z-20"); }
        if(tab === 'chat') { pChat.classList.remove("hidden"); pChat.classList.add("absolute", "w-full", "z-20"); }
        
        ['btnSeats','btnHints','btnChat'].forEach(b => {
            document.getElementById(b).classList.remove("bg-sky-100", "text-sky-700");
            document.getElementById(b).classList.add("bg-slate-100", "text-slate-500");
        });
        const activeBtn = tab === 'seats' ? 'btnSeats' : tab === 'hints' ? 'btnHints' : 'btnChat';
        document.getElementById(activeBtn).classList.add("bg-sky-100", "text-sky-700");
    }
}

function showResult(time) {
    document.getElementById("resultModal").classList.remove("hidden");
    document.getElementById("resultTime").innerText = time;
    
    const grid = document.getElementById("resultGrid");
    const lvl = LEVELS[gameState.settings.diff];
    grid.style.gridTemplateColumns = `repeat(${lvl.c}, minmax(0, 1fr))`;
    grid.innerHTML = "";
    
    gameState.answer.flat().forEach(name => {
        grid.innerHTML += `<div class="bg-white border border-emerald-200 p-2 text-center rounded font-bold text-emerald-700">${name}</div>`;
    });
}
</script>
</body>
</html>
